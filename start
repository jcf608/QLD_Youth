#!/bin/bash

echo "ğŸš€ Starting QLD Youth Justice Case Management System"
echo "=================================================="

# Configuration
BACKEND_PORT=3090
FRONTEND_PORT=3091

# Check if PostgreSQL is running
if ! pg_isready -h localhost > /dev/null 2>&1; then
    echo "âš ï¸  PostgreSQL is not running"
    echo ""
    
    # Check if Homebrew PostgreSQL is installed
    POSTGRES_SERVICE=$(brew services list 2>/dev/null | grep postgresql | awk '{print $1}' | head -1)
    
    if [ -n "$POSTGRES_SERVICE" ]; then
        echo "Would you like to start PostgreSQL ($POSTGRES_SERVICE)?"
        echo ""
        echo "  1) Start PostgreSQL and continue"
        echo "  2) Exit and start manually"
        echo ""
        read -p "Enter your choice [1-2]: " choice
        
        case $choice in
            1)
                echo ""
                echo "ğŸ”„ Starting PostgreSQL..."
                brew services start "$POSTGRES_SERVICE"
                
                # Wait for PostgreSQL to be ready
                max_attempts=10
                attempt=0
                while [ $attempt -lt $max_attempts ]; do
                    if pg_isready -h localhost > /dev/null 2>&1; then
                        echo "âœ… PostgreSQL started successfully"
                        echo ""
                        break
                    fi
                    sleep 1
                    attempt=$((attempt + 1))
                done
                
                if [ $attempt -eq $max_attempts ]; then
                    echo "âš ï¸  PostgreSQL started but not responding yet"
                    echo "   Continuing anyway..."
                    echo ""
                fi
                ;;
            2)
                echo ""
                echo "Please start PostgreSQL and try again:"
                echo "  brew services start $POSTGRES_SERVICE"
                echo ""
                exit 0
                ;;
            *)
                echo ""
                echo "âŒ Invalid choice. Exiting..."
                exit 1
                ;;
        esac
    else
        echo "PostgreSQL needs to be running."
        echo ""
        echo "Common ways to start PostgreSQL:"
        echo "  â€¢ Homebrew: brew services start postgresql@14"
        echo "  â€¢ Postgres.app: Open Postgres.app"
        echo "  â€¢ Manual: pg_ctl start"
        echo ""
        exit 1
    fi
else
    echo "âœ… PostgreSQL is running"
fi

# Check if database exists
if ! psql -lqt | cut -d \| -f 1 | grep -qw qld_youth_development; then
    echo "ğŸ“¦ Creating database..."
    createdb qld_youth_development
    bundle exec rake db:migrate
    bundle exec rake db:seed
else
    echo "âœ… Database exists"
fi

echo ""
echo "ğŸŒ Starting servers on sequential ports..."
echo "   Backend API:  http://localhost:$BACKEND_PORT"
echo "   Frontend UI:  http://localhost:$FRONTEND_PORT"
echo ""
echo "Press Ctrl+C to stop all servers"
echo ""

# Function to cleanup on exit
cleanup() {
    echo ""
    echo "ğŸ›‘ Stopping all servers..."
    jobs -p | xargs -r kill 2>/dev/null
    exit 0
}

trap cleanup EXIT INT TERM

# Start backend server on port 3090
echo "ğŸ”§ Starting backend on port $BACKEND_PORT..."
cd "$(dirname "$0")"
~/.rbenv/shims/bundle exec rackup -p $BACKEND_PORT 2>&1 | tee tmp/backend.log &
BACKEND_PID=$!

# Wait a moment for backend to start
sleep 2

# Check if backend started successfully
if ! kill -0 $BACKEND_PID 2>/dev/null; then
    echo "âŒ Backend failed to start. Check tmp/backend.log for errors"
    exit 1
fi

echo "âœ… Backend running on port $BACKEND_PORT (PID: $BACKEND_PID)"

# Check if frontend dependencies are installed
cd client
if [ ! -d "node_modules" ]; then
    echo "ğŸ“¦ Installing frontend dependencies..."
    npm install
    echo "âœ… Frontend dependencies installed"
    echo ""
fi

# Update frontend to use correct backend port
export VITE_API_URL="http://localhost:$BACKEND_PORT"

# Start frontend server on port 3091
echo "ğŸ¨ Starting frontend on port $FRONTEND_PORT..."
npm run dev -- --port $FRONTEND_PORT --host 2>&1 | tee ../tmp/frontend.log &
FRONTEND_PID=$!

# Wait a moment for frontend to start
sleep 2

# Check if frontend started successfully
if ! kill -0 $FRONTEND_PID 2>/dev/null; then
    echo "âŒ Frontend failed to start. Check tmp/frontend.log for errors"
    kill $BACKEND_PID 2>/dev/null
    exit 1
fi

echo "âœ… Frontend running on port $FRONTEND_PORT (PID: $FRONTEND_PID)"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ¨ System is ready!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸŒ Open in browser: http://localhost:$FRONTEND_PORT"
echo "ğŸ“¡ API endpoint: http://localhost:$BACKEND_PORT/api"
echo ""
echo "ğŸ“‹ Logs:"
echo "   Backend:  tmp/backend.log"
echo "   Frontend: tmp/frontend.log"
echo ""
echo "To view logs in real-time:"
echo "   tail -f tmp/backend.log"
echo "   tail -f tmp/frontend.log"
echo ""

# Wait for all background processes
wait

