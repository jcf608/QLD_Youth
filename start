#!/bin/bash

echo "ğŸš€ Starting QLD Youth Justice Case Management System"
echo "=================================================="

# Configuration
BACKEND_PORT=3090
FRONTEND_PORT=3091

# Check if PostgreSQL is running
if ! pg_isready > /dev/null 2>&1; then
    echo "âŒ PostgreSQL is not running. Please start PostgreSQL first."
    exit 1
fi

echo "âœ… PostgreSQL is running"

# Check if database exists
if ! psql -lqt | cut -d \| -f 1 | grep -qw qld_youth_development; then
    echo "ğŸ“¦ Creating database..."
    createdb qld_youth_development
    bundle exec rake db:migrate
    bundle exec rake db:seed
else
    echo "âœ… Database exists"
fi

echo ""
echo "ğŸŒ Starting servers on sequential ports..."
echo "   Backend API:  http://localhost:$BACKEND_PORT"
echo "   Frontend UI:  http://localhost:$FRONTEND_PORT"
echo ""
echo "Press Ctrl+C to stop all servers"
echo ""

# Function to cleanup on exit
cleanup() {
    echo ""
    echo "ğŸ›‘ Stopping all servers..."
    jobs -p | xargs -r kill 2>/dev/null
    exit 0
}

trap cleanup EXIT INT TERM

# Start backend server on port 3090
echo "ğŸ”§ Starting backend on port $BACKEND_PORT..."
cd "$(dirname "$0")"
~/.rbenv/shims/bundle exec rackup -p $BACKEND_PORT 2>&1 | tee tmp/backend.log &
BACKEND_PID=$!

# Wait a moment for backend to start
sleep 2

# Check if backend started successfully
if ! kill -0 $BACKEND_PID 2>/dev/null; then
    echo "âŒ Backend failed to start. Check tmp/backend.log for errors"
    exit 1
fi

echo "âœ… Backend running on port $BACKEND_PORT (PID: $BACKEND_PID)"

# Update frontend to use correct backend port
cd client
export VITE_API_URL="http://localhost:$BACKEND_PORT"

# Start frontend server on port 3091
echo "ğŸ¨ Starting frontend on port $FRONTEND_PORT..."
npm run dev -- --port $FRONTEND_PORT --host 2>&1 | tee ../tmp/frontend.log &
FRONTEND_PID=$!

# Wait a moment for frontend to start
sleep 2

# Check if frontend started successfully
if ! kill -0 $FRONTEND_PID 2>/dev/null; then
    echo "âŒ Frontend failed to start. Check tmp/frontend.log for errors"
    kill $BACKEND_PID 2>/dev/null
    exit 1
fi

echo "âœ… Frontend running on port $FRONTEND_PORT (PID: $FRONTEND_PID)"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ¨ System is ready!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸŒ Open in browser: http://localhost:$FRONTEND_PORT"
echo "ğŸ“¡ API endpoint: http://localhost:$BACKEND_PORT/api"
echo ""
echo "ğŸ“‹ Logs:"
echo "   Backend:  tmp/backend.log"
echo "   Frontend: tmp/frontend.log"
echo ""
echo "To view logs in real-time:"
echo "   tail -f tmp/backend.log"
echo "   tail -f tmp/frontend.log"
echo ""

# Wait for all background processes
wait

